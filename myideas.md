# PingCAP小作业

## 题目

Mydumper (https://github.com/maxbube/mydumper) 是一个 MySQL 全量备份工具，不支持将备份直接写到对象存储系统上，
现要利用 Mydumper 将 MySQL 数据库备份到对象存储上，
需要一个上传工具将本地备份上传到对象存储。

请设计实现一个小工具在**本地盘空间比较小**的情况下
将 MySQL 备份数据上传到对象存储
（比如 MySQL 数据库有 10G 大小，而 Mydumper 所能使用的空间只有 1G）。
对象存储可以用 minio (https://github.com/minio/minio) 。

注意：不考虑多次执行 mydumper 命令分批备份。

## 初次考虑

1. 这个需求，很显然地会想到说一边备份（每次备份出来的数据量不超过1G），
一边上传到对象存储。要保证上传成功之后将本地的备份删除，再继续备份剩余的数据
2. 要实现1，需要了解题目提供的mydumper的备份输出过程、minio的上传过程
3. 在实现1的一边备份一边上传一边删除的这个过程，可以做成同步，也可以做成异步（多goroutine各自负责一种工作，各自为战） 
4. 考虑工具的通用性，要设计成支持替换备份工具和对象存储的方案，也就是需要设计合理的接口，并可配置
5. 提供一个较友好的命令行

## 9/10补充

经过简单了解mydumer和minio后：
1. minio只需简单在代码中引入其客户端SDK即可，使用简单
2. mydumper提供分块备份机制，满足前面设想的一边备份一边上传再删除本地的设想
3. 难点在于如何控制mydumper中间的暂停，不然没法协调备份与上传进度
4. 在一台deepin系统电脑上mydumper的安装出错，尝试一段时间未解决；选择使用go-mydumper替代（命令兼容mydumper）

关于协调备份进度和上传进度，有以下两种设想
1. 尝试编写与open/write等相关的函数逻辑，编译成so
（比如说写完一部分后必需检测剩余空间，足够才继续，
不够则停顿，等待删除已备份好的块），使用sys.PRELOAD来控制
这比原先的mydumper所以来的so更优先链接。以这种方式替换mydumper逻辑
2. 比较简单的做法是：额外用一个goroutine去监测备份目录下的文件情况。
当监测到前面的块已写好，并且大小达到一定程度，则暂停mydumper进程（`kill -STOP PID`）
然后把已写好的块上传之后删除。（当然这个过程可以做的更优化一些），再把mydumper恢复


尝试按方案2进行，实现起来比较简单

## 9/10晚补充

关于控制mydumper备份进程，可以使用os包下对Process类提供Signal()方法实现



